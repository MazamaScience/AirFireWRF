<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saving Data Subsets • AirFireWRF</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Saving Data Subsets">
<meta property="og:description" content="AirFireWRF">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">AirFireWRF</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.15</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/WRFmet.html">AirFireWRF</a>
    </li>
    <li>
      <a href="../../articles/articles/Saving_Data_Subsets.html">Saving Data Subsets</a>
    </li>
    <li>
      <a href="../../articles/articles/Static_Layered_Plots.html">Static Layered Plots</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MazamaScience/AirFireWRF/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Saving_Data_Subsets_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Saving Data Subsets</h1>
                        <h4 class="author">Mazama Science</h4>
            
            <h4 class="date">9/1/2020</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/MazamaScience/AirFireWRF/blob/master/vignettes/articles/Saving_Data_Subsets.Rmd"><code>vignettes/articles/Saving_Data_Subsets.Rmd</code></a></small>
      <div class="hidden name"><code>Saving_Data_Subsets.Rmd</code></div>

    </div>

    
    
<p><em>NOTE: Because the size of model output files, R code in this vignette is not run when the package is built. This document contains output from commands run on September 2, 2020.</em></p>
<div id="wrf-output-size" class="section level2">
<h2 class="hasAnchor">
<a href="#wrf-output-size" class="anchor"></a>WRF Output Size</h2>
<p>The WRF model system is able to forecast a wide variety of meteorological variables across large portions of the Earth’s surface. This can result in hefty output files that take up lots of memory. For instance, an AirFire WRF model run for the PNW-4km domain tracks 147 variables for over 100,000 sample points across the Pacific Northwest. Therefore, hourly snapshot files from these runs are nearly 350MB:</p>
<pre><code>rawBytes &lt;- file.size("~/Data/WRF/PNW-4km_2020090112_07.nc")
utils:::format.object_size(rawBytes, "auto", "SI")</code></pre>
<pre><code>[1] "349.6 MB"</code></pre>
<p>Since AirFire usually forecasts about 84 hours ahead, a single model run can take up almost 30GB. The size of this output imposes a heavy IO and memory burden when working with WRF data, so it is important that we try reducing the size of these files as much as possible. One way we can do this is to subset the hourly forecast files to retain only the information we plan to use. We can also reduce memory usage by summarizing and compressing data. So in the case of WRF files, we have several options:</p>
<ul>
<li>Removing irrelevant meteorological variables.</li>
<li>Cropping out regions not of interest.</li>
<li>Rasterizing the raw spatial points into a layered RasterBrick image.</li>
<li>Saving and compressing raster object files.</li>
</ul>
<p>Let’s look at the advantages of subsetting with an example.</p>
</div>
<div id="subsetting-example" class="section level2">
<h2 class="hasAnchor">
<a href="#subsetting-example" class="anchor"></a>Subsetting Example</h2>
<p>Let’s choose a WRF file – such as hour 7 from the 2020-09-01 12pm run – and implement the improvements we outlined. To start with, we will retain 21 variables of interest to the AirFire team, crop out regions like Canada and the Pacific Ocean, and rasterize the points onto a 0.06 degree grid:</p>
<pre><code><a href="https://rdrr.io/pkg/AirFireWRF/man">library(AirFireWRF)
setWRFDataDir("~/Data/WRF")

modelName &lt;- "PNW-4km"
modelRun &lt;- "2020090112"
modelRunHour &lt;- 7

subset &lt;- wrf_load(
  modelName = modelName,
  modelRun = modelRun,
  modelRunHour = modelRunHour,
  vars = c("XLONG", "XLAT", "XLONG_U", "XLAT_U", "XLONG_V", "XLAT_V", "U", "V",
           "U10", "V10", "ZNU", "ZNW", "LU_INDEX", "Q2", "T", "T2", "TH2", 
           "HGT", "RAINNC", "CFRACT", "PBLH"),
  res = 0.06,
  xlim = c(-125, -105),
  ylim = c(39, 49)
)</a></code></pre>
<p>It takes a few seconds to load, but let’s see how much space we saved:</p>
<pre><code>subsetBytes &lt;- object.size(subset)
utils:::format.object_size(subsetBytes, "auto", "SI")</code></pre>
<pre><code>[1] "8 MB"</code></pre>
<p><code>8 MB</code> is a significant improvement from the original file’s <code>349.6 MB</code>! We can do even better when we save the raster object as a <code>.rda</code> file using xz compression:</p>
<pre><code>fileName &lt;- paste0(modelName, "_", modelRun, "_", stringr::str_pad(modelRunHour, 2, pad = "0"), ".rda")
filePath &lt;- file.path(getWRFDataDir(), fileName)

save(subset, file = filePath, compress = "xz")

fileBytes &lt;- file.size(filePath)
utils:::format.object_size(fileBytes, "auto", "SI")</code></pre>
<pre><code>[1] "1.9 MB"</code></pre>
<p>So from <code>349.6 MB</code> down to <code>1.9 MB</code>? Not bad! This size is much more manageable for quickly loading and working with WRF model output, and it can easily be achieved using existing <code><a href="../../reference/wrf_load.html">wrf_load()</a></code> parameters and the base R <code><a href="https://rdrr.io/r/base/save.html">save()</a></code> function.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jonathan Callahan, Tate Brasel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
