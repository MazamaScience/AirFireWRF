---
title: "Static Layered Plots"
author: "Mazama Science"
date: "8/11/2020"
output: html_document
vignette: >
  %\VignetteIndexEntry{Static Layered Plots}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE,
  message = FALSE,
  fig.width = 8, 
  fig.height = 5
)
```

This vignette will walk through the process of creating layered static plots 
with the WRFmet package.

## Layered WRF Plots

WRF datasets contain a wide variety of gridded meteorological readings. WRFmet 
provides a way to plot gridded data with several features--building up a static
image layer-by-layer.

```{r wrf_rasters}
library(WRFmet)

# Access a WRF NetCDF file
nc <- ncdf4::nc_open('~/Data/WRF/wrfout_d3-2020071512-f07-0000.nc')

# Define a common Raster grid
xlim <- c(-125, -111)
ylim <- c(42, 49)
rasterRes <- 0.06

# A RasterBrick with a single layer for elevation
elevRaster <- wrf_createRaster(
  nc = nc,
  vars = 'HGT',
  xlim = xlim,
  ylim = ylim,
  res = rasterRes
)

# A RasterBrick with layers for both U and V wind vector components
windRaster <- wrf_createRaster(
  nc = nc,
  vars = c('U10', 'V10'),
  xlim = xlim,
  ylim = ylim,
  res = rasterRes
)
```

We can use the PWFSLSmoke package to collect monitor readings and the 
MazamaSpatialUtils package for state and county polygons:

```{r spatial_points}
library(PWFSLSmoke)

monitors <- monitor_load(
  startdate = "2020-07-15",
  enddate = "2020-07-16"
) %>% monitor_subset(stateCodes = c('WA', 'OR', 'ID'))

means <- monitor_getDailyMean(monitors, startdate = "2020-07-15")

monitorPoints <- data.frame(
  x = monitors$meta$longitude,
  y = monitors$meta$latitude,
  value = as.numeric(means[1, 2:ncol(means)])
)
```

Now we can build up a plot layer by layer:
1. Base plot
2. Elevation raster
3. State borders
4. Monitor points
5. Wind vectorfield
6. Additional GGPlot features, such as color scales, coordinate systems, labels,
etc.

```{r wrf_plot}
wrfMap <- 
  # Define an empty plotting space
  ggplot2::ggplot() +
  # Draw the elevation raster
  layer_raster(
    raster = elevRaster
  ) +
  # Then draw state borders
  layer_states(
    xlim = xlim,
    ylim = ylim
  ) +
  # Then draw the points
  layer_points(
    points = monitorPoints
  ) +
  # Then draw the wind vectorfield
  layer_vectorField(
    uvRaster = windRaster,
    alpha = 0.75
  ) +
  # Crop the plot area
  ggplot2::coord_fixed(
    ratio = 1.3,
    xlim = xlim,
    ylim = ylim
  ) +
  # Set raster color palette
  ggplot2::scale_fill_gradient(
    low = 'darkblue',
    high = 'cornflowerblue',
    na.value = 'transparent'
  ) +
  # Set the point color palette
  ggplot2::scale_color_gradient(
    low = 'green',
    high = 'red',
    na.value = 'transparent'
  ) +
  # Set the plot labels
  ggplot2::labs(
    title = 'Elevation & Wind Map',
    x = 'Longitude',
    y = 'Latitude',
    fill = 'Elev (m)',
    color  = 'PM2.5'
  )

wrfMap
```

The AirFireModeling package allows us to load air quality data as Raster
objects.

```{r}
library(AirFireModeling)

AirFireModeling::setModelDataDir("~/Data/BlueSky")

# Load model run
rasterList <- AirFireModeling::raster_load(
  modelName = "PNW-4km",
  modelRun = 2020071500,
  xlim = xlim,
  ylim = ylim
)

# Extract a single RasterLayer from the BlueSky run RasterBrick
smokeRaster <- rasterList$`PNW-4km_2020071500`$X1594839600
```

And now let's plot that

```{r bluesky_plot}
blueskyMap <- 
  ggplot2::ggplot() +
  ggplot2::scale_fill_gradientn(
    colors = c('green', 'yellow', 'orange', 'red', 'maroon'),
    na.value = 'transparent'
  ) +
  layer_raster(
    raster = smokeRaster
  ) +
  layer_states(
    xlim = xlim,
    ylim = ylim
  ) +
  ggplot2::coord_fixed(
    ratio = 1.3,
    xlim = xlim,
    ylim = ylim
  ) +
  ggplot2::labs(
    title = 'Air Quality & Wind Map',
    x = 'Longitude',
    y = 'Latitude',
    fill = 'Air quality (pm 2.5)'
  )

blueskyMap
```

It looks like there's a bit of action in Washington--particularly around the
Tri-cities area with a spot of deep red. Let's zoom into that area for a better
visual. This time, let's do the following:

1. Load a higher resolution BlueSky Raster.
2. Load the wind component rasters again, but with a smaller extent.
3. Since the air quality readings are heavily skewed, lets filter out cells with
PM2.5 values < 2.

```{r}
xlim <- c(-120, -118)
ylim<- c(46, 47)

# Load model run
rasterList <- AirFireModeling::raster_load(
  modelName = "PNW-1.33km",
  modelRun = 2020071500,
  xlim = xlim,
  ylim = ylim
)

# Extract a single RasterLayer from the BlueSky run RasterBrick
smokeRaster <- rasterList$`PNW-1.33km_2020071500`$X1594839600
smokeRaster[smokeRaster < 2] <- NA

# A RasterBrick with layers for both U and V wind vector components
windRaster <- wrf_createRaster(
  nc = nc,
  vars = c('U10', 'V10'),
  xlim = xlim,
  ylim = ylim,
  res = rasterRes
)

blueskyMap <- 
  ggplot2::ggplot() +
  # Set raster color palette
  ggplot2::scale_fill_gradientn(
    colors = c('green', 'yellow', 'orange', 'red', 'maroon'),
    na.value = 'transparent'
  ) +
  layer_raster(
    raster = smokeRaster
  ) +
  layer_states(
    xlim = xlim,
    ylim = ylim
  ) +
  layer_vectorField(
    uvRaster = windRaster,
    arrowColor = 'black',
    alpha = 0.6
  ) +
  ggplot2::coord_fixed(
    ratio = 1.3,
    xlim = xlim,
    ylim = ylim
  ) +
  ggplot2::labs(
    title = 'Air Quality & Wind Map',
    x = 'Longitude',
    y = 'Latitude',
    fill = 'Air quality (pm 2.5)'
  )

blueskyMap
```